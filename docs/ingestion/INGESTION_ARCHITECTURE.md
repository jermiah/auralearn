# ðŸ—ï¸ Curriculum PDF Ingestion Pipeline - Architecture

## ðŸ“ System Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         LEARNAURA CURRICULUM INGESTION                   â”‚
â”‚                            Document Processing Pipeline                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ INPUT LAYER                                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  ðŸ“‚ Local File System                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ 1_OFFICIAL CURRICULUM by EDUCATION NATIONALE/          â”‚             â”‚
â”‚  â”‚   â”œâ”€ cycle2_francais.pdf                               â”‚             â”‚
â”‚  â”‚   â”œâ”€ cycle3_maths.pdf                                  â”‚             â”‚
â”‚  â”‚   â”œâ”€ cycle3_sciences.pdf                               â”‚             â”‚
â”‚  â”‚   â””â”€ ... (10-50 PDF files)                             â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ Read PDFs
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STORAGE LAYER                                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â˜ï¸ Supabase Storage                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ Bucket: curriculum_pdfs                                â”‚             â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚             â”‚
â”‚  â”‚ â”‚ - Private bucket (not public)                      â”‚ â”‚             â”‚
â”‚  â”‚ â”‚ - 50MB file size limit                             â”‚ â”‚             â”‚
â”‚  â”‚ â”‚ - PDF MIME type only                               â”‚ â”‚             â”‚
â”‚  â”‚ â”‚ - Authenticated access via service role key        â”‚ â”‚             â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚             â”‚
â”‚  â”‚                                                        â”‚             â”‚
â”‚  â”‚ Files:                                                 â”‚             â”‚
â”‚  â”‚   â€¢ cycle2_francais.pdf                                â”‚             â”‚
â”‚  â”‚   â€¢ cycle3_maths.pdf                                   â”‚             â”‚
â”‚  â”‚   â€¢ cycle3_sciences.pdf                                â”‚             â”‚
â”‚  â”‚   â€¢ ...                                                â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                          â”‚
â”‚  ðŸ“¦ Module: supabase_storage.py                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ class SupabaseStorageService:                          â”‚             â”‚
â”‚  â”‚   â€¢ create_bucket()                                    â”‚             â”‚
â”‚  â”‚   â€¢ upload_pdf(file_path)                              â”‚             â”‚
â”‚  â”‚   â€¢ download_pdf(storage_filename)                     â”‚             â”‚
â”‚  â”‚   â€¢ list_pdfs()                                        â”‚             â”‚
â”‚  â”‚   â€¢ get_pdf_url(signed_url)                            â”‚             â”‚
â”‚  â”‚   â€¢ upload_directory_pdfs(directory)                   â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ Download PDF bytes
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OCR LAYER                                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  ðŸ¤– Mistral OCR API (mistral-ocr-2505)                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ Input:  PDF bytes (base64 encoded)                     â”‚             â”‚
â”‚  â”‚ Prompt: "Extract all text from this French curriculum  â”‚             â”‚
â”‚  â”‚          PDF. Include page numbers and maintain        â”‚             â”‚
â”‚  â”‚          document structure."                          â”‚             â”‚
â”‚  â”‚                                                        â”‚             â”‚
â”‚  â”‚ Output: Structured text with page metadata            â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                          â”‚
â”‚  ðŸ“¦ Module: ocr_service.py                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ class MistralOCRService:                               â”‚             â”‚
â”‚  â”‚   â€¢ extract_text_from_pdf_bytes(pdf_bytes)             â”‚             â”‚
â”‚  â”‚   â€¢ extract_text_from_file(file_path)                  â”‚             â”‚
â”‚  â”‚   â€¢ batch_process_pdfs(pdf_files)                      â”‚             â”‚
â”‚  â”‚                                                        â”‚             â”‚
â”‚  â”‚ Returns:                                               â”‚             â”‚
â”‚  â”‚   {                                                    â”‚             â”‚
â”‚  â”‚     "filename": "curriculum.pdf",                      â”‚             â”‚
â”‚  â”‚     "doc_id": "abc123...",                             â”‚             â”‚
â”‚  â”‚     "total_pages": 45,                                 â”‚             â”‚
â”‚  â”‚     "pages": [                                         â”‚             â”‚
â”‚  â”‚       {                                                â”‚             â”‚
â”‚  â”‚         "page_number": 1,                              â”‚             â”‚
â”‚  â”‚         "text": "Full page text...",                   â”‚             â”‚
â”‚  â”‚         "char_count": 1234                             â”‚             â”‚
â”‚  â”‚       },                                               â”‚             â”‚
â”‚  â”‚       ...                                              â”‚             â”‚
â”‚  â”‚     ]                                                  â”‚             â”‚
â”‚  â”‚   }                                                    â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ Structured JSON
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CHUNKING LAYER                                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  âœ‚ï¸ Three-Level Hierarchical Chunking                                    â”‚
â”‚                                                                          â”‚
â”‚  LEVEL A: Subject Headings                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ Split by:                                              â”‚             â”‚
â”‚  â”‚   â€¢ Volet 1, Volet 2, Volet 3                          â”‚             â”‚
â”‚  â”‚   â€¢ Subject names (FranÃ§ais, MathÃ©matiques, ...)       â”‚             â”‚
â”‚  â”‚   â€¢ Cycle markers                                      â”‚             â”‚
â”‚  â”‚                                                        â”‚             â”‚
â”‚  â”‚ Output: Large subject-level sections                   â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                          â”‚                                              â”‚
â”‚                          â–¼                                              â”‚
â”‚  LEVEL B: Section Types                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ Split by:                                              â”‚             â”‚
â”‚  â”‚   â€¢ Objectifs / finalitÃ©s                              â”‚             â”‚
â”‚  â”‚   â€¢ CompÃ©tences travaillÃ©es                            â”‚             â”‚
â”‚  â”‚   â€¢ Connaissances et compÃ©tences associÃ©es             â”‚             â”‚
â”‚  â”‚   â€¢ RepÃ¨res de progression                             â”‚             â”‚
â”‚  â”‚   â€¢ Situations d'apprentissage                         â”‚             â”‚
â”‚  â”‚                                                        â”‚             â”‚
â”‚  â”‚ Output: Section-level chunks                           â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                          â”‚                                              â”‚
â”‚                          â–¼                                              â”‚
â”‚  LEVEL C: Token-Based Chunks                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ Rules:                                                 â”‚             â”‚
â”‚  â”‚   â€¢ 150-300 tokens per chunk                           â”‚             â”‚
â”‚  â”‚   â€¢ Preserve sentence boundaries                       â”‚             â”‚
â”‚  â”‚   â€¢ Keep lists together                                â”‚             â”‚
â”‚  â”‚   â€¢ Minimum 50 tokens                                  â”‚             â”‚
â”‚  â”‚   â€¢ Track original page numbers                        â”‚             â”‚
â”‚  â”‚                                                        â”‚             â”‚
â”‚  â”‚ Output: Fine-grained content chunks                    â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                          â”‚
â”‚  ðŸ“¦ Module: chunking.py                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ class CurriculumChunker:                               â”‚             â”‚
â”‚  â”‚   â€¢ chunk_document(pages_data)                         â”‚             â”‚
â”‚  â”‚   â€¢ _level_a_chunking(pages)                           â”‚             â”‚
â”‚  â”‚   â€¢ _level_b_chunking(subject_sections)                â”‚             â”‚
â”‚  â”‚   â€¢ _level_c_chunking(sub_sections)                    â”‚             â”‚
â”‚  â”‚   â€¢ _create_chunk(chunk_data)                          â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ Raw chunks
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ METADATA ENRICHMENT LAYER                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  ðŸ·ï¸ Metadata Extraction & Enrichment                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ Extract from chunk text:                               â”‚             â”‚
â”‚  â”‚   â€¢ cycle: "2", "3", "4"                               â”‚             â”‚
â”‚  â”‚   â€¢ grades: ["CM1", "CM2", "6e", "5e", ...]            â”‚             â”‚
â”‚  â”‚   â€¢ subject: "FranÃ§ais", "MathÃ©matiques", ...          â”‚             â”‚
â”‚  â”‚   â€¢ section_type: "objectives", "competencies", ...    â”‚             â”‚
â”‚  â”‚   â€¢ topic: Main topic name                             â”‚             â”‚
â”‚  â”‚   â€¢ subtopic: Subtopic (if applicable)                 â”‚             â”‚
â”‚  â”‚   â€¢ is_cycle_wide: true/false                          â”‚             â”‚
â”‚  â”‚   â€¢ page_start, page_end: Original page numbers        â”‚             â”‚
â”‚  â”‚   â€¢ source_paragraph_id: Paragraph reference           â”‚             â”‚
â”‚  â”‚   â€¢ doc_id: Source document ID                         â”‚             â”‚
â”‚  â”‚   â€¢ lang: "fr"                                         â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                          â”‚
â”‚  ðŸ“¦ Module: metadata.py                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ class MetadataBuilder:                                 â”‚             â”‚
â”‚  â”‚   â€¢ enrich_chunk_metadata(chunk)                       â”‚             â”‚
â”‚  â”‚   â€¢ _extract_from_text(text)                           â”‚             â”‚
â”‚  â”‚   â€¢ _detect_cycle(text)                                â”‚             â”‚
â”‚  â”‚   â€¢ _detect_grades(text)                               â”‚             â”‚
â”‚  â”‚   â€¢ _detect_subject(text)                              â”‚             â”‚
â”‚  â”‚   â€¢ _detect_section_type(text)                         â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ Enriched chunks
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VALIDATION LAYER                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  âœ… Multi-Level Validation                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ 1. Schema Validation (Pydantic)                        â”‚             â”‚
â”‚  â”‚    â€¢ All required fields present                       â”‚             â”‚
â”‚  â”‚    â€¢ Correct data types                                â”‚             â”‚
â”‚  â”‚    â€¢ Field constraints met                             â”‚             â”‚
â”‚  â”‚                                                        â”‚             â”‚
â”‚  â”‚ 2. Content Validation                                  â”‚             â”‚
â”‚  â”‚    â€¢ chunk_text length >= 50 chars                     â”‚             â”‚
â”‚  â”‚    â€¢ chunk_text not empty/whitespace                   â”‚             â”‚
â”‚  â”‚    â€¢ page_start <= page_end                            â”‚             â”‚
â”‚  â”‚                                                        â”‚             â”‚
â”‚  â”‚ 3. Metadata Validation                                 â”‚             â”‚
â”‚  â”‚    â€¢ Valid grades (CM1, CM2, 6e, etc.)                 â”‚             â”‚
â”‚  â”‚    â€¢ Valid subject names                               â”‚             â”‚
â”‚  â”‚    â€¢ Valid cycle ("2", "3", "4")                       â”‚             â”‚
â”‚  â”‚    â€¢ Grades present if not cycle_wide                  â”‚             â”‚
â”‚  â”‚                                                        â”‚             â”‚
â”‚  â”‚ 4. Duplicate Detection                                 â”‚             â”‚
â”‚  â”‚    â€¢ Check for duplicate chunk IDs                     â”‚             â”‚
â”‚  â”‚    â€¢ Flag identical content                            â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                          â”‚
â”‚  ðŸ“¦ Module: schemas.py + metadata.py + supabase_db.py                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ class CurriculumChunk(BaseModel):                      â”‚             â”‚
â”‚  â”‚   â€¢ Pydantic validators                                â”‚             â”‚
â”‚  â”‚   â€¢ Type checking                                      â”‚             â”‚
â”‚  â”‚   â€¢ Field constraints                                  â”‚             â”‚
â”‚  â”‚                                                        â”‚             â”‚
â”‚  â”‚ validate_chunk(chunk):                                 â”‚             â”‚
â”‚  â”‚   â€¢ Content validation                                 â”‚             â”‚
â”‚  â”‚   â€¢ Metadata validation                                â”‚             â”‚
â”‚  â”‚   â€¢ Returns: True/False                                â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ Valid chunks only
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DATABASE LAYER                                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  ðŸ’¾ Supabase PostgreSQL Database                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ Table: curriculum_chunks                               â”‚             â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚             â”‚
â”‚  â”‚ â”‚ Columns:                                           â”‚ â”‚             â”‚
â”‚  â”‚ â”‚   â€¢ id (UUID, PK)                                  â”‚ â”‚             â”‚
â”‚  â”‚ â”‚   â€¢ doc_id (TEXT)                                  â”‚ â”‚             â”‚
â”‚  â”‚ â”‚   â€¢ cycle (TEXT)                                   â”‚ â”‚             â”‚
â”‚  â”‚ â”‚   â€¢ grades (TEXT[])  â† PostgreSQL array            â”‚ â”‚             â”‚
â”‚  â”‚ â”‚   â€¢ subject (TEXT)                                 â”‚ â”‚             â”‚
â”‚  â”‚ â”‚   â€¢ section_type (TEXT)                            â”‚ â”‚             â”‚
â”‚  â”‚ â”‚   â€¢ topic (TEXT)                                   â”‚ â”‚             â”‚
â”‚  â”‚ â”‚   â€¢ subtopic (TEXT)                                â”‚ â”‚             â”‚
â”‚  â”‚ â”‚   â€¢ is_cycle_wide (BOOLEAN)                        â”‚ â”‚             â”‚
â”‚  â”‚ â”‚   â€¢ chunk_text (TEXT)                              â”‚ â”‚             â”‚
â”‚  â”‚ â”‚   â€¢ page_start (INTEGER)                           â”‚ â”‚             â”‚
â”‚  â”‚ â”‚   â€¢ page_end (INTEGER)                             â”‚ â”‚             â”‚
â”‚  â”‚ â”‚   â€¢ source_paragraph_id (TEXT)                     â”‚ â”‚             â”‚
â”‚  â”‚ â”‚   â€¢ lang (TEXT)                                    â”‚ â”‚             â”‚
â”‚  â”‚ â”‚   â€¢ created_at (TIMESTAMP)                         â”‚ â”‚             â”‚
â”‚  â”‚ â”‚   â€¢ updated_at (TIMESTAMP)                         â”‚ â”‚             â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚             â”‚
â”‚  â”‚                                                        â”‚             â”‚
â”‚  â”‚ Indexes:                                               â”‚             â”‚
â”‚  â”‚   â€¢ idx_curriculum_chunks_subject (B-tree)             â”‚             â”‚
â”‚  â”‚   â€¢ idx_curriculum_chunks_grades (GIN)                 â”‚             â”‚
â”‚  â”‚   â€¢ idx_curriculum_chunks_cycle (B-tree)               â”‚             â”‚
â”‚  â”‚   â€¢ idx_curriculum_chunks_topic (B-tree)               â”‚             â”‚
â”‚  â”‚   â€¢ idx_curriculum_chunks_section_type (B-tree)        â”‚             â”‚
â”‚  â”‚   â€¢ idx_curriculum_chunks_cycle_wide (Partial)         â”‚             â”‚
â”‚  â”‚                                                        â”‚             â”‚
â”‚  â”‚ RLS Policies:                                          â”‚             â”‚
â”‚  â”‚   â€¢ Teachers can read curriculum chunks                â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                          â”‚
â”‚  ðŸ“¦ Module: supabase_db.py                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ class SupabaseDatabaseService:                         â”‚             â”‚
â”‚  â”‚   â€¢ upsert_chunks(chunks)                              â”‚             â”‚
â”‚  â”‚     â†³ Batch size: 100 chunks                           â”‚             â”‚
â”‚  â”‚     â†³ Conflict resolution: UPDATE on duplicate ID      â”‚             â”‚
â”‚  â”‚     â†³ Progress tracking                                â”‚             â”‚
â”‚  â”‚                                                        â”‚             â”‚
â”‚  â”‚   â€¢ search_chunks(filters)                             â”‚             â”‚
â”‚  â”‚   â€¢ get_chunks_by_subject_and_grades()                 â”‚             â”‚
â”‚  â”‚   â€¢ get_cycle_wide_chunks()                            â”‚             â”‚
â”‚  â”‚   â€¢ get_table_stats()                                  â”‚             â”‚
â”‚  â”‚   â€¢ validate_chunk_data()                              â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OUTPUT LAYER                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  ðŸ“Š Structured Curriculum Data Ready for Use                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ âœ… PDFs stored in Supabase Storage                      â”‚             â”‚
â”‚  â”‚ âœ… Text extracted and parsed                            â”‚             â”‚
â”‚  â”‚ âœ… Chunks created and enriched                          â”‚             â”‚
â”‚  â”‚ âœ… Metadata extracted                                   â”‚             â”‚
â”‚  â”‚ âœ… All data validated                                   â”‚             â”‚
â”‚  â”‚ âœ… Saved to Supabase database                           â”‚             â”‚
â”‚  â”‚                                                        â”‚             â”‚
â”‚  â”‚ Ready for:                                             â”‚             â”‚
â”‚  â”‚   â€¢ Subject filtering                                  â”‚             â”‚
â”‚  â”‚   â€¢ Grade-level queries                                â”‚             â”‚
â”‚  â”‚   â€¢ Topic searches                                     â”‚             â”‚
â”‚  â”‚   â€¢ Cycle-wide content retrieval                       â”‚             â”‚
â”‚  â”‚   â€¢ Full-text search                                   â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ”„ Pipeline Orchestration

### Main Orchestrator: `pipeline.py`

```python
class AssessmentPipeline:
    def initialize_curriculum_database(self):
        """
        Main orchestration method
        Executes all pipeline stages in sequence
        """

        # Stage 1: Storage Setup
        storage = SupabaseStorageService()
        storage.create_bucket()

        # Stage 2: Upload PDFs
        uploaded_files = storage.upload_directory_pdfs(
            "1_OFFICIAL CURRICULUM by EDUCATION NATIONALE"
        )

        # Stage 3: OCR Processing
        ocr_service = MistralOCRService()
        ocr_results = []
        for filename in uploaded_files:
            local_path = storage.download_pdf(filename)
            result = ocr_service.extract_text_from_file(local_path)
            ocr_results.append(result)

        # Stage 4: Chunking
        chunker = CurriculumChunker()
        all_chunks = []
        for ocr_result in ocr_results:
            chunks = chunker.chunk_document(ocr_result['pages'])
            all_chunks.extend(chunks)

        # Stage 5: Metadata Enrichment
        metadata_builder = MetadataBuilder()
        enriched_chunks = []
        for chunk in all_chunks:
            enriched = metadata_builder.enrich_chunk_metadata(chunk)
            if metadata_builder.validate_chunk(enriched):
                enriched_chunks.append(enriched)

        # Stage 6: Database Save
        db_service = SupabaseDatabaseService()
        db_service.upsert_chunks(enriched_chunks)
```

---

## ðŸ”Œ Module Dependencies

```
pipeline.py (Main Orchestrator)
    â”‚
    â”œâ”€â–º supabase_storage.py
    â”‚       â””â”€â–º Supabase Client
    â”‚           â””â”€â–º SUPABASE_URL
    â”‚           â””â”€â–º SUPABASE_SERVICE_ROLE_KEY
    â”‚
    â”œâ”€â–º ocr_service.py
    â”‚       â””â”€â–º Mistral AI Client
    â”‚           â””â”€â–º MISTRAL_API_KEY
    â”‚           â””â”€â–º MISTRAL_MODEL
    â”‚
    â”œâ”€â–º chunking.py
    â”‚       â””â”€â–º schemas.py (CurriculumChunk)
    â”‚
    â”œâ”€â–º metadata.py
    â”‚       â””â”€â–º schemas.py (CurriculumChunk)
    â”‚
    â””â”€â–º supabase_db.py
            â””â”€â–º Supabase Client
            â””â”€â–º schemas.py (CurriculumChunk)
```

---

## ðŸ“¦ Data Models

### CurriculumChunk Schema (Pydantic)

```python
class CurriculumChunk(BaseModel):
    id: str                          # UUID
    doc_id: str                      # Source document ID
    cycle: str                       # "2", "3", "4"
    grades: List[str]                # ["CM1", "CM2"]
    subject: str                     # "FranÃ§ais", "MathÃ©matiques"
    section_type: str                # "objectives", "competencies"
    topic: str                       # Main topic
    subtopic: str                    # Subtopic
    is_cycle_wide: bool              # Applies to whole cycle?
    chunk_text: str                  # Actual content (150-300 tokens)
    page_start: int                  # Starting page
    page_end: int                    # Ending page
    source_paragraph_id: str         # Paragraph reference
    lang: str = "fr"                 # Language

    # Pydantic validators ensure:
    # - grades not empty if not cycle_wide
    # - page_start <= page_end
    # - all required fields present
```

---

## ðŸŒ External Services

### 1. Mistral AI (OCR)

```
Endpoint: https://api.mistral.ai/v1/chat/completions
Model: mistral-ocr-2505
Authentication: Bearer token (MISTRAL_API_KEY)

Request:
    POST /v1/chat/completions
    {
        "model": "mistral-ocr-2505",
        "messages": [
            {
                "role": "user",
                "content": [
                    {
                        "type": "document_url",
                        "document_url": "data:application/pdf;base64,..."
                    },
                    {
                        "type": "text",
                        "text": "Extract all text..."
                    }
                ]
            }
        ]
    }

Response:
    {
        "choices": [
            {
                "message": {
                    "content": "Extracted text with page structure..."
                }
            }
        ]
    }
```

### 2. Supabase (Database + Storage)

```
Database URL: https://[project-id].supabase.co
Authentication: Service Role Key

Storage API:
    POST /storage/v1/object/curriculum_pdfs/[filename]
    GET  /storage/v1/object/curriculum_pdfs/[filename]
    GET  /storage/v1/object/list/curriculum_pdfs

Database API:
    POST /rest/v1/curriculum_chunks (upsert)
    GET  /rest/v1/curriculum_chunks?select=*&filters
```

---

## ðŸš€ Execution Flow

### Command Line

```bash
python -m backend.assessment_pipeline initialize
```

### Execution Steps

```
1. Load Environment Variables
   â†“
2. Initialize Services
   â”œâ”€ SupabaseStorageService (with service role key)
   â”œâ”€ MistralOCRService (with API key)
   â”œâ”€ CurriculumChunker
   â”œâ”€ MetadataBuilder
   â””â”€ SupabaseDatabaseService
   â†“
3. Create Storage Bucket
   â†“
4. Upload PDFs (parallel)
   â”œâ”€ cycle2_francais.pdf â†’ Supabase Storage
   â”œâ”€ cycle3_maths.pdf â†’ Supabase Storage
   â””â”€ ...
   â†“
5. Download & OCR (sequential per PDF)
   â”œâ”€ Download cycle2_francais.pdf
   â”œâ”€ OCR â†’ JSON (pages)
   â”œâ”€ Download cycle3_maths.pdf
   â”œâ”€ OCR â†’ JSON (pages)
   â””â”€ ...
   â†“
6. Chunk Documents (in-memory)
   â”œâ”€ Level A: Subject splitting
   â”œâ”€ Level B: Section splitting
   â””â”€ Level C: Token chunking
   â†“
7. Enrich Metadata (in-memory)
   â”œâ”€ Extract cycle, grades, subject
   â”œâ”€ Extract section type, topic
   â””â”€ Flag cycle-wide chunks
   â†“
8. Validate Chunks (in-memory)
   â”œâ”€ Schema validation
   â”œâ”€ Content validation
   â””â”€ Filter invalid chunks
   â†“
9. Batch Upsert to Database
   â”œâ”€ Batch 1 (100 chunks) â†’ Supabase
   â”œâ”€ Batch 2 (100 chunks) â†’ Supabase
   â””â”€ ...
   â†“
10. Complete âœ…
```

---

## ðŸ“Š Performance Characteristics

### Time Complexity

| Stage | Complexity | Time (per PDF) |
|-------|-----------|----------------|
| Upload | O(1) | ~5 seconds |
| OCR | O(pages) | ~30-120 seconds |
| Chunking | O(pages Ã— text) | ~5-10 seconds |
| Metadata | O(chunks) | ~1-5 seconds |
| Validation | O(chunks) | ~1 second |
| Database | O(chunks) | ~5-10 seconds |

**Total per PDF:** ~50-150 seconds

### Space Complexity

| Component | Size |
|-----------|------|
| PDF file | ~5-10 MB |
| OCR result | ~100-500 KB |
| Chunks (JSON) | ~500 KB - 2 MB |
| Database row | ~1 KB per chunk |

---

## ðŸ” Security

### Authentication

- âœ… Supabase Service Role Key (backend only)
- âœ… Mistral API Key (backend only)
- âœ… No credentials in frontend
- âœ… Environment variables (.env file)

### Access Control

- âœ… Supabase Storage: Private bucket
- âœ… Supabase Database: RLS policies
- âœ… Authenticated teacher access
- âœ… Service role for backend operations

### Data Protection

- âœ… HTTPS for all API calls
- âœ… Encrypted at rest (Supabase)
- âœ… Encrypted in transit (TLS)
- âœ… Signed URLs for temporary access

---

## âœ… What This Architecture Does

### INCLUDED (âœ…):
- âœ… PDF upload to Supabase Storage
- âœ… Mistral OCR text extraction
- âœ… Structured JSON parsing
- âœ… 3-level hierarchical chunking
- âœ… Metadata enrichment
- âœ… Content validation
- âœ… Supabase database storage
- âœ… Batch processing
- âœ… Error handling

### NOT INCLUDED (âŒ):
- âŒ Vector embeddings (OpenAI)
- âŒ Vector database (Qdrant)
- âŒ Semantic search / RAG
- âŒ Question generation (LLM)
- âŒ Assessment creation
- âŒ Retrieval logic
- âŒ Teacher profile filtering (for ingestion)

---

**Architecture Version:** 1.0
**Last Updated:** 2025-11-16
**Status:** Production Ready âœ…
