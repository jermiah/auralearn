# Token-Based Authentication Mechanism Explained

## ğŸ” How Token Authentication Works

### Overview
The individual assessment links use **token-based authentication** - a secure, passwordless authentication method where the token itself serves as the credential.

---

## ğŸ”„ Complete Authentication Flow

### 1. **Token Generation (Server-Side)**
```
When a student is created:
â”œâ”€ Database automatically generates UUID token
â”œâ”€ Token stored in students.assessment_token
â”œâ”€ Expiration date set (30 days from creation)
â””â”€ Token is cryptographically unique (UUID v4)
```

**SQL:**
```sql
ALTER TABLE students
ADD COLUMN assessment_token UUID DEFAULT uuid_generate_v4() UNIQUE;
```

---

### 2. **Link Distribution**
```
Teacher shares link:
https://localhost:8081/student-assessment/token/550e8400-e29b-41d4-a716-446655440000
                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                          Student's unique token
```

**Security:** The token is the authentication credential - anyone with the link can access.

---

### 3. **Token Validation (When Student Clicks Link)**

**File:** `src/pages/StudentAssessment.tsx`

```typescript
// Step 1: Extract token from URL
const { token } = useParams(); // Gets token from /student-assessment/token/:token

// Step 2: Validate token via Supabase function
const validation = await validateAssessmentToken(token);

// Step 3: Check validation result
if (!validation.valid) {
  // Show error: "Invalid or expired token"
  return <ErrorPage />;
}

// Step 4: If valid, load student info
const studentId = validation.studentId;
const studentData = await loadStudent(studentId);

// Step 5: Student is now "authenticated" - proceed with assessment
```

---

### 4. **Token Validation Function**

**File:** `src/services/assessment-token-service.ts`

```typescript
export async function validateAssessmentToken(token: string) {
  // Calls Supabase RPC function
  const { data } = await supabase.rpc('validate_assessment_token', {
    token_uuid: token,
  });
  
  return {
    valid: data.valid,
    studentId: data.student_id,
    studentName: data.student_name,
    classId: data.class_id,
    errorMessage: data.error_message
  };
}
```

---

### 5. **Database Validation (Supabase Function)**

**File:** `supabase-assessment-token-migration.sql`

```sql
CREATE OR REPLACE FUNCTION validate_assessment_token(token_uuid UUID)
RETURNS TABLE(
  valid BOOLEAN,
  student_id UUID,
  student_name TEXT,
  class_id UUID,
  primary_category student_category,
  error_message TEXT
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    CASE
      WHEN s.id IS NULL THEN FALSE                    -- Token doesn't exist
      WHEN s.token_expires_at < NOW() THEN FALSE      -- Token expired
      ELSE TRUE                                        -- Token is valid
    END AS valid,
    s.id AS student_id,
    s.name AS student_name,
    s.class_id AS class_id,
    s.primary_category AS primary_category,
    CASE
      WHEN s.id IS NULL THEN 'Invalid token'
      WHEN s.token_expires_at < NOW() THEN 'Token has expired'
      ELSE NULL
    END AS error_message
  FROM students s
  WHERE s.assessment_token = token_uuid;
END;
$$ LANGUAGE plpgsql;
```

**Validation Checks:**
1. âœ… Token exists in database
2. âœ… Token hasn't expired (< 30 days old)
3. âœ… Returns student information if valid

---

## ğŸ”’ Security Model

### What Makes This Secure?

#### 1. **Cryptographically Unique Tokens**
```
UUID v4 format: 550e8400-e29b-41d4-a716-446655440000
- 128-bit number
- 2^128 possible combinations
- Practically impossible to guess
```

#### 2. **Token Expiration**
```
Default: 30 days
- Tokens automatically expire
- Reduces risk of old links being used
- Can be regenerated by teacher
```

#### 3. **One Token Per Student**
```
Database constraint: UNIQUE
- Each student has exactly one token
- No token sharing between students
- Token regeneration invalidates old token
```

#### 4. **Access Logging**
```
Every access is logged:
- Student ID
- Token used
- Timestamp
- Access method (token vs manual)
- IP address (optional)
```

---

## ğŸ†š Comparison: Token vs Traditional Auth

### Traditional Authentication (Username/Password)
```
Student Flow:
1. Navigate to login page
2. Enter username
3. Enter password
4. Click login
5. Session created
6. Access assessment

Problems:
âŒ Students forget passwords
âŒ Need account creation
âŒ Password reset flows
âŒ Session management
âŒ Complex for young students
```

### Token Authentication (Current System)
```
Student Flow:
1. Click link from email
2. Automatically authenticated
3. Access assessment

Benefits:
âœ… No passwords to remember
âœ… No account creation needed
âœ… One-click access
âœ… Perfect for young students
âœ… Easy for parents to manage
âœ… Secure (cryptographic tokens)
```

---

## ğŸ” Security Features

### 1. **Token Uniqueness**
```sql
assessment_token UUID UNIQUE
```
- Database enforces uniqueness
- No two students can have same token
- Prevents token collision

### 2. **Token Expiration**
```sql
token_expires_at TIMESTAMP DEFAULT (NOW() + INTERVAL '30 days')
```
- Automatic expiration
- Configurable duration
- Reduces long-term risk

### 3. **Token Regeneration**
```typescript
async function regenerateAssessmentToken(studentId: string) {
  // Generates new UUID
  // Invalidates old token
  // Updates expiration date
  return newToken;
}
```
- Teacher can regenerate if compromised
- Old token immediately invalid
- New token with fresh expiration

### 4. **Access Logging**
```sql
CREATE TABLE assessment_access_log (
  student_id UUID,
  token_used UUID,
  access_method TEXT,
  accessed_at TIMESTAMP,
  ip_address TEXT
);
```
- Complete audit trail
- Track who accessed when
- Detect suspicious activity

---

## ğŸš¨ Security Considerations

### What This System Protects Against:

âœ… **Password Guessing** - No passwords to guess
âœ… **Brute Force** - 2^128 possible tokens (impossible to brute force)
âœ… **Account Takeover** - No accounts to take over
âœ… **Phishing** - No credentials to phish
âœ… **Session Hijacking** - No sessions to hijack

### What This System Does NOT Protect Against:

âš ï¸ **Link Sharing** - If student shares link, anyone can use it
âš ï¸ **Link Interception** - If link is intercepted (email, etc.), can be used
âš ï¸ **Device Theft** - If device with link is stolen, link can be used

### Mitigation Strategies:

1. **Token Expiration** - Limits window of vulnerability
2. **Token Regeneration** - Teacher can invalidate compromised tokens
3. **Access Logging** - Detect unusual access patterns
4. **Parent Email** - Links sent to parents, not students directly
5. **HTTPS** - Encrypts link in transit (production requirement)

---

## ğŸ”„ Token Lifecycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TOKEN LIFECYCLE                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. CREATION
   â”œâ”€ Student added to class
   â”œâ”€ UUID token generated automatically
   â”œâ”€ Expiration set to NOW() + 30 days
   â””â”€ Token stored in database

2. DISTRIBUTION
   â”œâ”€ Teacher views Assessment page
   â”œâ”€ Copies individual token link
   â””â”€ Shares with parent via email

3. USAGE
   â”œâ”€ Student clicks link
   â”œâ”€ Token validated against database
   â”œâ”€ If valid: Access granted
   â”œâ”€ If invalid: Error shown
   â””â”€ Access logged

4. EXPIRATION
   â”œâ”€ After 30 days, token expires
   â”œâ”€ Validation fails
   â”œâ”€ Student sees "Token expired" error
   â””â”€ Teacher must regenerate token

5. REGENERATION (Optional)
   â”œâ”€ Teacher clicks "Regenerate" button
   â”œâ”€ New UUID generated
   â”œâ”€ Old token invalidated
   â”œâ”€ New expiration set
   â””â”€ New link shared with parent
```

---

## ğŸ’¡ Why This Approach?

### Design Decisions:

#### 1. **Passwordless by Design**
- Target audience: Elementary school students (CM1/CM2, ages 9-11)
- Password management too complex for this age
- Parents manage links, not students

#### 2. **Email-to-Parent Model**
- Links sent to parents, not students
- Parents control access
- Reduces risk of link sharing among students

#### 3. **Token-Based vs Session-Based**
- No server-side session management
- Stateless authentication
- Scales better
- Simpler implementation

#### 4. **Dual-Access System**
- Token links for home/remote assessments
- Class-wide links for in-class assessments
- Flexibility for different scenarios

---

## ğŸ” How to Verify Security

### Check Token Uniqueness:
```sql
SELECT assessment_token, COUNT(*) 
FROM students 
GROUP BY assessment_token 
HAVING COUNT(*) > 1;
-- Should return 0 rows
```

### Check Token Expiration:
```sql
SELECT name, token_expires_at, 
       token_expires_at < NOW() as is_expired
FROM students;
```

### Check Access Logs:
```sql
SELECT s.name, a.access_method, a.accessed_at
FROM assessment_access_log a
JOIN students s ON s.id = a.student_id
ORDER BY a.accessed_at DESC;
```

---

## ğŸ“Š Authentication Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Student  â”‚
â”‚ Clicks   â”‚
â”‚ Link     â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ URL: /student-assessment/token/ABC  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ StudentAssessment Component         â”‚
â”‚ - Extracts token from URL           â”‚
â”‚ - Calls validateAssessmentToken()   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Token Validation Service            â”‚
â”‚ - Calls Supabase RPC function       â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Database Validation Function        â”‚
â”‚ - Checks token exists               â”‚
â”‚ - Checks token not expired          â”‚
â”‚ - Returns student info if valid     â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€â”€â”€ Valid â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                  â–¼
     â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚         â”‚ Load Student    â”‚
     â”‚         â”‚ Load Questions  â”‚
     â”‚         â”‚ Show Assessment â”‚
     â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â””â”€â”€â”€ Invalid â”€â”€â”€â”€â”€â”€â”
                        â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚ Show Error Page â”‚
               â”‚ "Invalid Token" â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Summary

**Authentication Mechanism:**
- **Type:** Token-based, passwordless authentication
- **Token:** UUID v4 (128-bit cryptographic identifier)
- **Storage:** Database (students.assessment_token)
- **Validation:** Server-side Supabase function
- **Expiration:** 30 days (configurable)
- **Security:** Cryptographically unique, time-limited, regenerable
- **Audit:** Complete access logging

**Key Principle:**
> The token IS the authentication credential. Possession of a valid token grants access to that specific student's assessment.

This is similar to how:
- Password reset links work (token in URL)
- Magic links work (Slack, Medium, etc.)
- API keys work (token = credential)

**Perfect for:**
- Young students who can't manage passwords
- Parent-controlled access
- One-time or limited-time access
- Simple, frictionless user experience
